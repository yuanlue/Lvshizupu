<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>底部导航</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>

    <style>
        html, body {
            height: 100%;
            width: 100%;
            margin:0;
        }
        #footer {
            width: 100%;
            text-align: center;
            height: 52px;
            box-sizing: border-box;
            line-height: 52px;
            background-color: #fff;
            border-top:1px solid #dbdbdb;
        }
        #footer li img{
          width:24px;
          vertical-align: middle;
          display: inline
        }
        ul {

            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
        }


        #footer{
          position: fixed;
          bottom:0;
        }
        #footer li {
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
            height: 48px;
        }

        .bottom_btn {

            background-position-y: 4px;
            font-size: 14px;
            color: #323237;
            height: 39px;
            margin-left:5px;
            background-repeat: no-repeat no-repeat;
            background-position-x: center;
            background-size: 30px;
        }



        .active .bottom_btn {
            color: #9e2932;
            background-size: 30px;
        }

        .topbar {
            background-image: url("../../image/status.png");
            background-size: cover;
            height: 50px;
            border-bottom: 1px solid #DDDFE3;
            line-height: 50px;
            text-align: center;
            font-size:17px;
            display: none;
            color:white;

        }

        .activebar {
            display: block;
            padding: 0;
            margin:0;
        }
        .top{
          height:25px;
          background: black;
        }
        ul li:active{
          background: #eee
        }
        #footer ul .active:before{
          content:"";
          display:inline-block;
          background: url("../../image/fish.png") no-repeat;
          background-size: cover;
          width:28px;
          height:12px;
          position: absolute;
          bottom:12px;

        }
        header>div{
          position: relative;
        }
        header>div>span{
          width:20px;
          position: absolute;
          right:10px;
        }
          header>div>span img{
            width:100%;
          }
          header>div>span i{
            position: absolute;
            top:5px;
            right:10px;
            font-size:12px;
            border-radius: 50%;
            background: white;
            line-height: 15px;
            font-style: normal;
            text-align: center;
            width:15px;
            height:15px;
            display:none;
            color:#9e2932;
          }
          #dev>img{
            width:20px;
            line-height: 50px;
            position: absolute;
            left:10px;
            top:13px
          }
          .popup{
            z-index:2001;
            background: rgba(0,0,0,0.5);
            position: fixed;;
            top:0;
            width:100vw;
            display: none;
            height:100vh;
          }
    </style>
</head>
<body>
  <div class="top"></div>
<div id="wrap">
    <header>
        <div id="cloud" class="topbar  activebar" onclick="clear()">
                    天下吕氏
                    <span>
                      <img onclick="message()" src="../../image/message.png" alt="">
                      <i></i>
                    </span>

        </div>

        <div id="dev" class="topbar ">
                  <img onclick="menu()" class="menu" src="../../image/market/menu.png" alt="">
                    商城
                    <span><img onclick="message()" src="../../image/message.png" alt="">
                      <i></i>
                    </span>

        </div>
        <div id="doc" class="topbar ">
                    我的
                    <span><img onclick="message()" src="../../image/message.png" alt="">
                      <i></i>
</span>

        </div>
    </header>

    <div id="footer">
        <ul>
            <li tapmode="active" class="active" onclick="randomSwitchBtn(this,'cloud',0)">
              <img src="../../image/lv.png" alt="">
                <a class="bottom_btn cloud">首页</a>
            </li>



            <li tapmode="active" onclick="randomSwitchBtn(this,'dev',1)">
              <img src="../../image/shang.png" alt="">

                <a class="bottom_btn dev ">商城</a>
            </li>

            <li tapmode="active" onclick="randomSwitchBtn(this,'doc',2)">
              <img src="../../image/ren.png" alt="">

                <a class="bottom_btn doc ">我的</a>
            </li>

        </ul>
    </div>

</div>
</div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="../../script/exit.js"></script>
<script type="text/javascript" src="../../script/enc_base64.js"></script>
<script type="text/javascript" src="../../script/service.js"></script>
<script type="text/javascript" src="../../script/websocket.js"></script>

<script type="text/javascript">

Array.prototype.unique = function(){
 var res = [this[0]];
 for(var i = 1; i < this.length; i++){
  var repeat = false;
  for(var j = 0; j < res.length; j++){
   if(this[i] == res[j]){
    repeat = true;
    break;
   }
  }
  if(!repeat){
   res.push(this[i]);
  }
 }
 return res;
}

function menu(){
  var $header = $api.dom('header');
  $api.fixIos7Bar($header);
  var $body = $api.dom('body');
  var $footer = $api.byId('footer');
  var header_h = $api.offset($header).h;
  var body_h = $api.offset($body).h;
  var footer_h = $api.offset($footer).h;

  var rect_h = body_h - header_h - footer_h;
  var y=50+  $('.top').height()
  if(!isiOS){
    rect_h=rect_h-25

  }
  api.openWin({
      name: 'MarketUserWin',
      url: '../../html/user/MarketUserCenterWin.html',

      bounces: false,
      animation:{
        type:"push",                //动画类型（详见动画类型常量）
        subType:"from_left",       //动画子类型（详见动画子类型常量）
        duration:200
      },
      bgColor: 'rgba(0,0,0,0.2)',
      vScrollBarEnabled: true,
      hScrollBarEnabled: true
  });

}
function re(name){
  if(name=='info'){
    sysInfo=[];
    sysNum=clientMessage.length;
    sysNum?$('header>div>span i').text(sysNum):$('header>div>span i').hide()

  }
  else if(name=='client'){
    clientMessage=[];
    sysNum=sysInfoMessage.length;
    sysNum?$('header>div>span i').text(sysNum):$('header>div>span i').hide()
  }
  if(clientMessage==[]&&sysInfoMessage==[]){
    sysNum=0
    $('header>div>span i').hide()

  }

}

function message(){
  api.openWin({
      name: 'remind',
      url: '../../html/friend/remind.html'
  });

}
    apiready = function () {
      var time=new Date()
      var sysNum=0;
      api.addEventListener({
      name:'noticeclicked'
  },function(ret,err){
    if(!JSON.parse(ret.value).data){
      api.openWin({
          name: 'friend',
          url: '../../html/friend/friendWin.html',

      });
      return
    }
      api.openWin({
          name: 'clientContactWin',
          url: '../../html/friend/clientContactWin.html',
          pageParam: {
              id: JSON.parse(ret.value).data.sender_id,
              avata:JSON.parse(ret.value).data.data.split(',')[0],
              name:JSON.parse(ret.value).data.data.split(',')[1]
          }
      });
  });
       sysInfoMessage=[]
       clientMessage=[]
      setInterval(function(){
        if($api.getStorage('user_id')){
          ws.send('ping')
          wssClient.send('ping')

        }


     },10000);

       let wssClient=new ReconnectingWebSocket("wss://wx2.kuaiyunma.com/sub/im/user_"+$api.getStorage('user_id'));
       wssClient.onmessage = function(evt){
         if(evt.data=="pong"){
           return false
         }
         if($api.getStorage('clientMessage')){
           clientMessage=$api.getStorage('clientMessage')
           clientMessage.forEach(item=>{
              if(JSON.stringify(item)==JSON.stringify(JSON.parse(evt.data).data)){
                return false
              }
           })
         }
         sysNum++;
         var time=0
         if($api.getStorage('clientTime')){
           time = parseInt($api.getStorage('clientTime'));
         }
         var messagetime=new Date(JSON.parse(evt.data).data.created_at).getTime()
         if(time>parseInt(messagetime)){
           return false
         }
         if(sysNum>0){
           clientMessage.push(JSON.stringify(JSON.parse(evt.data).data))
           clientMessage=clientMessage.unique()

           $('header>div>span i').show()

           var messnum=parseInt($('header>div>span i').text())
           $('header>div>span i').text(clientMessage.length+sysInfoMessage.length)

           api.notification({
             sound:'default',
               notify: {
                   title:'天下吕氏',
                   content: '您有新的客服消息',
                   updateCurrent: true,
                   extra:JSON.parse(evt.data)
               }
           }, function(ret, err) {
               var id = ret.id;
           });

           clientMessage=clientMessage.unique()

           $api.setStorage('clientMessage', clientMessage);
           api.execScript({
               name: 'remind',
               frameName: 'remindFrame',
               script: 'getClient();'
           });
            let str="updateList('"+evt.data+"')";
           api.execScript({
               name: 'clientContactWin',
               frameName: 'clientContactFrame',
               script: str
           });

         }
       }
      //系统消息
      var ws = new ReconnectingWebSocket("wss://wx2.kuaiyunma.com/sub/sys/"+$api.getStorage('user_id'));
        ws.onmessage = function(evt){
          if(evt.data=="pong"){
            return false
          }
          if(JSON.parse(evt.data).message_type=="clan_user.approval.success"){
              //审核通过
              var jsfun = 'chatInit();';
              getData('/users/profile',function(data){
                if(data.code==200){
                  if(data.data.uid==false){
                  }
                  else{
                    $api.setStorage('uid', data.data.uid);
                    $api.setStorage('joined_family',"true");
                    api.execScript({
                    frameName: 'home',
                    script: jsfun
                });
                  }
                }
                else{

                }
              },{},{'Authorization':$api.getStorage('token')})


          }
          if($api.getStorage('sysInfo')){
            sysInfoMessage=$api.getStorage('sysInfo')
          }
          sysNum++;
          var time=0
          if($api.getStorage('sysCTime')){
            time = parseInt($api.getStorage('sysCTime'));
          }
          var messagetime=new Date(JSON.parse(evt.data).created_at).getTime()

          if(time>parseInt(messagetime)){
            return false
          }
          if(sysNum>0){
            sysInfoMessage.push(JSON.parse(evt.data).content+','+JSON.parse(evt.data).created_at)
            sysInfoMessage=sysInfoMessage.unique()

            $('header>div>span i').show()
            $('header>div>span i').text(clientMessage.length+sysInfoMessage.length)
            api.notification({
              sound:'default',
                notify: {
                    title:'天下吕氏',
                    content: '您有新的系统消息',
                    updateCurrent: true
                }
            }, function(ret, err) {
                var id = ret.id;
            });
            sysInfoMessage=sysInfoMessage.unique()
            $api.setStorage('sysInfo', sysInfoMessage);
            api.execScript({
                name: 'remind',
                frameName: 'remindFrame',
                script: 'getInfo();'
            });
          }

        };



            api.addEventListener({
            name:'offline'
        }, function(ret, err){
          api.toast({
                  msg: '当前网络状态不稳定',
                  duration:2000,
                  location: 'bottom'
              });
        });

        exitApp()
      var u = navigator.userAgent;
      var isAndroid = u.indexOf('Android') > -1 || u.indexOf('Adr') > -1; //android终端
       isiOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); //ios终端
      if(isiOS){
        $('.top').hide()
      }


  var $header = $api.dom('header');
  $api.fixIos7Bar($header);
  var $body = $api.dom('body');
  var $footer = $api.byId('footer');
  var header_h = $api.offset($header).h;
  var body_h = $api.offset($body).h;
  var footer_h = $api.offset($footer).h;

  var rect_h = body_h - header_h - footer_h;
   y=45+  $('.top').height()

  if(!isiOS){rect_h=rect_h-25;   y=50+  $('.top').height()}
  api.openFrame({
      name: 'home',
      url: '../../html/Home/main.html',
      rect: {
          x: 0,
          y: y,
          w: 'auto',
          h: rect_h
      },
      customRefreshHeader: 'UIPullRefreshFlash',
      reload:true,
      bounces: true,
      bgColor: 'rgba(0,0,0,0)',
      vScrollBarEnabled: true,
      hScrollBarEnabled: true
  });


//       rong.getTotalUnreadCount(function(ret, err) {
//       })
//       rong.getConversationList(function (ret, err) {
//
// })


        api.openFrameGroup({
            name: 'group',
            scrollEnabled: false,

            rect: {  x: 0,
                     y: y,
                     w: 'auto',
                     h:rect_h
                  },
            index: 0,
            frames: [
                {
                    name: 'home',
                    url: '../../html/Home/main.html',
                    customRefreshHeader: 'UIPullRefreshFlash',
                    useWKWebView:true,
                    reload:true
                },
                {
                    name: 'market',
                    url: '../../html/market/marketWin.html',
                    useWKWebView:true,
                    allowEdit:true,
                    reload:true
                },
                {
                    name: 'userCenter',
                    url: '../../html/user/userCenterWin.html',
                    reload:true
                }
            ]
        }, function (ret, err) {
          api.setFrameAttr({ // 隐藏内容层
                    name: 'home',
                    hidden:true,
                });
                api.setFrameAttr({ // 隐藏内容层
                          name: 'market',
                          hidden:true,
                      });
                api.setFrameAttr({ // 隐藏内容层
                          name: 'userCenter',
                          hidden:true,
                      });
          $('ul').find('li').removeClass('active')
          $('header').find('div').removeClass('activebar')
          $('header').find('div').eq(ret.index).addClass('activebar')
          $('ul').find('li').eq(ret.index).addClass('active')


        });
//                滑动

    }
    // 随意切换按钮
    function randomSwitchBtn(obj, name, index) {
      var $header = $api.dom('header');
      $api.fixIos7Bar($header);
      var $body = $api.dom('body');
      var $footer = $api.byId('footer');
      var header_h = $api.offset($header).h;
      var body_h = $api.offset($body).h;
      var footer_h = $api.offset($footer).h;

      var rect_h = body_h - header_h - footer_h;
      var y=45+  $('.top').height()
      if(!isiOS){rect_h=rect_h-25;   y=50+  $('.top').height()}

      if(name=='cloud'){
        api.setFrameAttr({ // 隐藏内容层
                  name: 'market',
                  hidden:true,
              });
              api.setFrameAttr({ // 隐藏内容层
                        name: 'userCenter',
                        hidden:true,
                    });
        api.setFrameGroupIndex({
          name: 'group',
          index: 0
      });



      }
      else if(name=='dev'){
        api.setFrameAttr({ // 隐藏内容层
                  name: 'home',
                  hidden:true,
              });
              api.setFrameAttr({ // 隐藏内容层
                        name: 'userCenter',
                        hidden:true,
                    });
        api.setFrameGroupIndex({
    name: 'group',
    index: 1
});

      }
      else if(name=='doc'){

        api.setFrameGroupIndex({
      name: 'group',
      index: 2
  });
      }
        var $header = $api.dom('header');
        var $titleBar = $api.domAll($header, '.topbar');
        for (var i = 0; i < $titleBar.length; i++) {
            $api.removeCls($titleBar[i], 'activebar');
        }
        $api.addCls($api.byId(name), 'activebar');
        var $footer = $api.byId('footer');
        var $footerBar = $api.domAll($footer, 'li');
        for (var j = 0; j < $footerBar.length; j++) {
            $api.removeCls($footerBar[j], 'active');
        }
        $api.addCls(obj, 'active');



    }
</script>
</html>
