<!DOCTYPE html>
  <html>
  <head>
      <meta charset="utf-8">
      <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
      <title>title</title>
      <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
      <style>
      *:focus {
           outline: none;
          background-color: transparent;
       }
      body{
          background: url("../../image/background.png");
          background-position: bottom center;
          background-size: cover;
          height:100vh;
          box-sizing: border-box;
          overflow: hidden;
      }
          .logo{
            text-align: center;
          }
        .logo img{
          width:67px;
          height:67px;
          border:1px solid #ccad73;
          border-radius: 50%;
        }
        .loginInfo{
          width:80vw;
          margin:0 aut0;
          font-size:13px;
          margin:0 auto 0;
          line-height:35px;
          padding-top:10px;
        }
        .loginInfo input{
          line-height: 35px;
          width:80vw;
          border-radius: 0;
          border-bottom:1px solid #35322a;
        }
        .loginInfo #tel{
          width:45vw;
        }
        .info{
          margin-top:30px;
        }
        @media screen and (max-width: 320px) {
          .info{
            margin-top:30px;
          }
}
        .info .text{
          display: block;
          width:80vw;
          margin:20px auto;
        }
        @media screen and (max-width: 320px) {
          .info .text{
            display: block;
            width:80vw;
            margin:10px auto;
          }
}
        .info .text .message,.info .text .message{
          color:#9e2931;
          font-size:12px;
        }
        .info .text .forget{
          color:black;
          font-size:12px;
          float: right;
        }
        .opera{
          margin-top:30px;
          text-align: center;
        }
        .opera button{
          width:80vw;
          color:white;
          padding:12px 0;
          border-radius: 20px;
          background: url('../../image/status.png');
          background-size: cover;
          background-position: bottom center;
        }
        .register{
          margin-top:10px;
          text-align: center;
          font-size:13px;
        }
        .register span{
          color:blue
        }
        .other{
          text-align: center;
          margin-top:20px;
          font-size:12px;
        }
        .other p:before,  .other p:after{
          content:"";
          display: inline-block;
          width:75px;
          margin:0 5px;
          vertical-align: middle;
          height:1px;
          background:#9e2931;
        }
        .other ul{
          margin-top:10px;
        }
        .other li img{
          width:36px;
        }
        .register span{
          color:#9e2931;
          text-decoration: underline;
        }
        .loginInfo>span{
          margin-top:10px;
          line-height:30px;
          float: right;
          border:1px solid #c19b56;
          color:#c19b56;
          border-radius: 20px;
          padding:0 15px;
          margin-left:5px;
        }
        .logo{
          margin-top:40px;
        }
        .logo >span{
          background: url('../../image/status.png');

          position:absolute;
          top:15px;
          left:5px;
          font-size:13px;
          margin-top:10px;
          line-height:30px;
          float: right;
          color:#fff;
          border-radius: 20px;
          padding:0 15px;
        }
        .loginInfo{
          position: relative;
        }
        .loginInfo i{
          display: inline-block;
          background: url('../../image/closeeye.png');
          height:10px;
          background-size: cover;
          position: absolute;
          width:23px;
          bottom:10px;
          right:0;
        }
        .loginInfo .active{
          background: url('../../image/openeye.png') no-repeat;
          display: inline-block;
          height:15px;
          background-size: contain;
          position: absolute;
          width:23px;
          bottom:10px;
          right:0;
        }
        .logo .welcome{
          font-size:15px;
          margin:15px 0;
          color:#9e2931;
        }
        .logo p{
          font-size:15px;
        }
        .top{
          height:25px;
          background: black;
        }
        .topbar {
          background-image: url("../../image/status.png");
          background-size: cover;
          height: 50px;
          border-bottom: 1px solid #DDDFE3;
          line-height: 50px;
          text-align: center;
          font-size:17px;
          color:white;
        }
        #cloud .return{
          width:12px;
          position: absolute;
          left:10px;
          top:13px;
        }
      </style>
  </head>
  <body>
    <div class="top"></div>
    <header>
        <div id="cloud" class="topbar  activebar">
          <img class="return" onclick="api.closeWin()" src="../../image/return.png" alt="">
                    绑定账号
        </div>
    </header>
  <div class="logo">
    <img src="../../image/default.png" alt="">
    <p class="welcome">亲爱的<span>“微信昵称”</span></p>
    <p>为了您的账户安全，请关联您的手机号</p>
  </div>
  <div class="info">
    <div class="loginInfo"><input type="number" id="tel" onblur="comReg()" placeholder="已输入手机号"><span onclick="verification()">获取验证码</span></div>
    <div class="loginInfo"> <input type="text" id="message" onblur="comReg()" placeholder="填写验证码"></div>
    <div style="display:none" id="pwd" class="loginInfo"> <input type="password" id="password" placeholder="6-16位登录密码"><i onclick="eye()"></i></div>

    <div class="opera">
      <button onclick="login()">立即登录绑定</button>
    </div>
  </div>


  </body>
  <script type="text/javascript" src="../../script/api.js"></script>
  <script type="text/javascript" src="../../script/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="../../script/hideShowPassword.min.js"></script>
  <script type="text/javascript" src="../../script/sha1.js"></script>
  <script type="text/javascript" src="../../script/service.js"></script>

  <script type="text/javascript">
  var num=0

  tar=$api.dom('body')
  $api.css(tar,'height:'+window.screen.height+'px');
  var now = Date.now();
  function backNum(){
    if(num==0){
      return false
    }
    num--;

  }
function comReg(){

  		postData('/users/is_registered',function(res){
  			if(res.code==-1){
  				//表示用户已经注册
  				$('#pwd').show()
  			}
  			else{
  				$('#pwd').hide()
  			}
  		},{'mobile':$('#password').val()})

  	}
function agreement(){
  api.openWin({
      name: 'agreement',
      url: '../../html/login/Agreement.html',

  });

}
  function eye(){
    a=$('#password').attr('type')
    if(a!='password'){
      $('#password').attr('type','password')
    }
    else{
      $('#password').attr('type','text')
    }
    $('.loginInfo i').toggleClass("active");

  }
  function messageLogin(){
      api.openFrame({
          name: 'messageLogin',
          url: '../../html/login/messageLogin.html',
          rect: {
              x: 0,
              y: 0,
              w: 'auto',
              h: 'auto'
          },
          bounces: false,
          bgColor: 'rgba(0,0,0,0)',
          vScrollBarEnabled: true,
          hScrollBarEnabled: true,
          slidBackEnabled:false
      });

  }

  function verification(){
    if(num!=0){
      api.toast({
              msg: '发送验证码失败,请'+num+'秒后重试！',
              duration:2000,
              location: 'bottom'
          });
          return false

    }
    var partten = /^1[34578]\d{9}$/;
    if(partten.test($('#tel').val()))
    {
      //电话号码格式正确
      postData('/sms/'+$('#tel').val()+'/send',function(res){
      //发送验证码
        if(res.code==200){
          api.toast({
                  msg: '发送成功',
                  duration:2000,
                  location: 'bottom'
              });
              num=120
              window.setInterval("backNum()",1000)
        }
        else{
          api.toast({
                  msg: '发送失败,请稍后重试',
                  duration:2000,
                  location: 'bottom'
              });
        }
      })

    }
    else
    {
      //电话号码格式错误
      api.toast({
              msg: '电话号码格式错误',
              duration:2000,
              location: 'bottom'
          });
    }

  }
  function login(){
    //验证是否已经注册
    var user={
      "user":
    {
      "mobile":$('#tel').val(),
      "password":$('#password').val(),
      "avatar":api.pageParam.avatar,
      "user_name":api.pageParam.userName,
      "sex":api.pageParam.sex,
      "unionid":api.pageParam.unionid
    }
  }
    postData('/sms/'+$('#tel').val()+'/validate',function(res){
      if(res.code==200){
        //验证成功
        //进行注册

      $.ajax({
  				url:"https://wx2.kuaiyunma.com/weixin/oauth2_bind",
  				beforeSend: function(xhr) {
       				 xhr.setRequestHeader("X-CSRF-Token", $("meta[name=\"csrf-token\"]").attr("content"));
    			},
  				data:user,
  				type:"post",
  				success:function(sta){
  					if(sta.code==200){
              api.toast({
                      msg: '恭喜您，绑定成功',
                      duration:2000,
                      location: 'bottom'
                  });
                  $api.setStorage('token',sta.data.token)
                  $api.setStorage('mobile',sta.data.mobile);
                  $api.setStorage('uid',sta.data.uid);
                  $api.setStorage('joined_family',sta.data.joined_family);
                  $api.setStorage('avata',sta.data.avatar);
                  $api.setStorage('user_id',data.data.user_id);


                  api.openWin({
                      name: 'home',
                      url: '../../html/Home/homeWin.html',
                      pageParam:{
                        token:sta.data.token
                      },
                      useWKWebView:false,
                      historyGestureEnabled:false,
                      slidBackEnabled:false
                  });

  					}
  					else{
              api.toast({
                      msg: '绑定失败',
                      duration:2000,
                      location: 'bottom'
                  });

  					}
  				}
  			})
      }
      else{
        api.toast({
                msg: '验证码输入有误',
                duration:2000,
                location: 'bottom'
            });
      }
    },{'code':$('#message').val()})
  }
      apiready = function(){
        var u = navigator.userAgent;

        var isAndroid = u.indexOf('Android') > -1 || u.indexOf('Adr') > -1; //android终端
        var isiOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); //ios终端
        if(isiOS){
          $('.top').css({'background':'white',"height":"20px"})
        }
      $('.welcome span').text(api.pageParam.userName)
      $('.logo img').attr('src',api.pageParam.avatar)
      };
  </script>
  </html>
